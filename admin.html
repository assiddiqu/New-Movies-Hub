<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin Panel | New Movies Hub</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { 
  getFirestore, collection, getDocs, doc, updateDoc, setDoc, serverTimestamp, onSnapshot, increment 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { 
  getStorage, ref, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

// üî• Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAVDNb6kqr5wjIO20XNgMEuXtwwx_1ViMo",
  authDomain: "mini-ac455.firebaseapp.com",
  projectId: "mini-ac455",
  storageBucket: "mini-ac455.firebasestorage.app",
  messagingSenderId: "83336316469",
  appId: "1:83336316469:web:5f322a38a090b947bc537c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ‚úÖ Check admin login
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Please login as admin!");
    window.location.href = "index.html";
  } else {
    const usersCol = collection(db,"users");
    const userSnapshot = await getDocs(usersCol);
    let isAdmin = false;
    userSnapshot.forEach(doc => {
      if(doc.data().email === user.email && doc.data().role === "admin") isAdmin = true;
    });
    if(!isAdmin){
      alert("You are not admin!");
      window.location.href = "index.html";
    } else {
      loadUsers();
      loadCustomization();
      loadViewers();
    }
  }
});

// Load all users
async function loadUsers(){
  const usersCol = collection(db,"users");
  const snapshot = await getDocs(usersCol);
  const tbody = document.getElementById("user-table-body");
  tbody.innerHTML = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.email || data.phone || "N/A"}</td>
      <td>${data.phone || "-"}</td>
      <td>${data.role}</td>
      <td>${data.lastLogin ? new Date(data.lastLogin.seconds*1000).toLocaleString() : "-"}</td>
      <td>
        <button onclick="changeRole('${doc.id}','${data.role}')">Toggle Role</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Toggle role admin/viewer
async function changeRole(uid, currentRole){
  const newRole = currentRole === "admin" ? "viewer" : "admin";
  const userRef = doc(db,"users",uid);
  await updateDoc(userRef,{role: newRole});
  alert("Role changed to "+newRole);
  loadUsers();
}

// Load customization
async function loadCustomization(){
  const homepageRef = doc(db,"customization","homepage");
  const homepageSnap = await getDocs(collection(db,"customization"));
  document.getElementById("homepage-title").value = "New Movies Hub"; // default
  document.getElementById("banner-preview").src = document.getElementById("banner-preview").dataset.src || "";
}

// Update homepage title
async function updateTitle(){
  const newTitle = document.getElementById("homepage-title").value;
  const homepageRef = doc(db,"customization","homepage");
  await setDoc(homepageRef, { title: newTitle }, { merge: true });
  alert("Homepage title updated!");
}

// Upload banner image
async function uploadBanner(event){
  const file = event.target.files[0];
  if(!file) return;
  const storageRef = ref(storage,"banner/"+file.name);
  await uploadBytes(storageRef,file);
  const url = await getDownloadURL(storageRef);
  const homepageRef = doc(db,"customization","homepage");
  await setDoc(homepageRef,{bannerImg:url},{merge:true});
  document.getElementById("banner-preview").src = url;
  alert("Banner updated!");
}

// Logout
function logout(){
  signOut(auth).then(()=>window.location.href="index.html");
}

// Load viewers realtime
function loadViewers(){
  const viewersCol = collection(db,"viewers");
  onSnapshot(viewersCol, snapshot => {
    const tbody = document.getElementById("viewer-table-body");
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.email || data.phone || "N/A"}</td>
        <td>${data.lastVisit ? new Date(data.lastVisit.seconds*1000).toLocaleString() : "-"}</td>
        <td>${data.online ? "‚úÖ Online" : "‚ùå Offline"}</td>
        <td>${data.visitsCount || 0}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}

window.changeRole = changeRole;
window.updateTitle = updateTitle;
window.uploadBanner = uploadBanner;
window.logout = logout;
</script>

<style>
body { font-family: Arial; background: #111; color: white; padding:20px; }
h1,h2 { text-align:center; }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th,td { border:1px solid #444; padding:10px; text-align:center; }
button { padding:5px 10px; margin:2px; cursor:pointer; border:none; border-radius:5px; background:red; color:white; }
button:hover { background:darkred; }
input[type=text] { padding:5px; width:200px; }
img { max-width:300px; margin-top:10px; display:block; }
</style>
</head>
<body>
<h1>Admin Panel | New Movies Hub</h1>
<button onclick="logout()">Logout</button>

<h2>All Users</h2>
<table>
<thead>
<tr>
<th>Email</th>
<th>Phone</th>
<th>Role</th>
<th>Last Login</th>
<th>Action</th>
</tr>
</thead>
<tbody id="user-table-body"></tbody>
</table>

<h2>Website Customization</h2>
<div>
<label>Homepage Title:</label>
<input type="text" id="homepage-title">
<button onclick="updateTitle()">Update Title</button>
</div>
<div>
<label>Banner Image:</label>
<input type="file" onchange="uploadBanner(event)">
<img id="banner-preview" src="" data-src="">
</div>

<h2>Live Viewer Stats</h2>
<table>
<thead>
<tr>
<th>Email / Phone</th>
<th>Last Visit</th>
<th>Online</th>
<th>Total Visits</th>
</tr>
</thead>
<tbody id="viewer-table-body"></tbody>
</table>
</body>
</html>
